CREATE DATABASE TESTE_TOSHIRO;

CREATE TABLE CLIENTES (
COD_CLI INTEGER PRIMARY KEY AUTO_INCREMENT,
NOME VARCHAR(80) NOT NULL,
CIDADE VARCHAR(50) NOT NULL,
UF CHAR(2) NOT NULL
);
ALTER TABLE CLIENTES ADD INDEX IND_NOME_CLI (NOME);

CREATE TABLE PRODUTOS (
COD_PROD INTEGER PRIMARY KEY AUTO_INCREMENT,
DESCRICAO VARCHAR(50) NOT NULL,
PRECO_VENDA DECIMAL(16,2)
);

ALTER TABLE PRODUTOS ADD INDEX IND_DESC_PROD (DESCRICAO);

CREATE TABLE PEDIDO (
NUM_PEDIDO INTEGER PRIMARY KEY  AUTO_INCREMENT,
DT_EMISSAO DATE NOT NULL,
COD_CLI INTEGER NOT NULL,
VLR_TOTAL DECIMAL(16,2) NOT NULL
);

ALTER TABLE PEDIDO ADD FOREIGN KEY FK_CLIENTE (COD_CLI) REFERENCES CLIENTES(COD_CLI);
ALTER TABLE PEDIDO ADD INDEX IND_EMIS_PED (DT_EMISSAO);

CREATE TABLE ITENS_PEDIDO (
NUM_PEDIDO INTEGER NOT NULL,
ITEM INTEGER NOT NULL,
COD_PROD INTEGER NOT NULL,
QUANTIDADE DECIMAL(16,2) NOT NULL,
VLR_UNIT DECIMAL(16,2) NOT NULL,
VLR_TOTAL DECIMAL(16,2) NOT NULL
);

ALTER TABLE ITENS_PEDIDO ADD PRIMARY KEY (NUM_PEDIDO, ITEM);
ALTER TABLE ITENS_PEDIDO ADD FOREIGN KEY FK_PEDIDO (NUM_PEDIDO) REFERENCES PEDIDO(NUM_PEDIDO);
ALTER TABLE ITENS_PEDIDO ADD FOREIGN KEY FK_PROD (COD_PROD) REFERENCES PRODUTOS(COD_PROD);

DELIMITER $

CREATE TRIGGER TRIGGER_SEQ_ITEM_PED BEFORE INSERT on ITENS_PEDIDO
FOR EACH ROW BEGIN
  DECLARE PCONT INT;

  SET PCONT = (SELECT COALESCE(MAX(ITEM),0) + 1 FROM ITENS_PEDIDO WHERE NUM_PEDIDO = NEW.NUM_PEDIDO);

  SET NEW.ITEM = PCONT;

END$
DELIMITER ;

DELIMITER $
CREATE PROCEDURE INSERIR_REGISTROS (PTABELA VARCHAR(20), PQTDE INTEGER, PPRECO DECIMAL(16,2))
BEGIN
	DECLARE CONT INTEGER DEFAULT 1;
    
    WHILE CONT <= PQTDE DO
		IF PTABELA = 'CLIENTES' THEN
			INSERT INTO CLIENTES (NOME, CIDADE, UF) VALUES (CONCAT('CLIENTE ', CAST(CONT AS CHAR(3))), 
															CONCAT('CIDADE ', CAST(CONT AS CHAR(3))), 
                                                            'PR');
		ELSE
        	IF PTABELA = 'PRODUTOS' THEN 
				INSERT INTO PRODUTOS (DESCRICAO, PRECO_VENDA) VALUES (CONCAT('PRODUTO ', CAST(CONT AS CHAR(3))), PPRECO * CONT);
			END IF;
		END IF;
        
        SET CONT = CONT + 1;
        
    END WHILE;    
END$
DELIMITER ;

CALL INSERIR_REGISTROS('CLIENTES', 30, 0);

CALL INSERIR_REGISTROS('PRODUTOS', 20, 1.25);










